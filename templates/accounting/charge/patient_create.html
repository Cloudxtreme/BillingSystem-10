{% extends "base.html" %}

{% load staticfiles %}
{% load widget_tweaks %}
{% load index %}

{% block title %} Apply Payment {% endblock title %}

{% block body %}

{% if pc_formset.errors %}
    {% for error in pc_formset.errors %}
        {{ error }}
    {% endfor %}
{% endif %}

{% if pc_formset.non_form_errors %}
    {{ pc_formset.non_form_errors }}
{% endif %}

<div class="container">
    <h2 class="text-center">Apply Payment</h2>
    {% include "accounting/apply/payment_claim_search.html" %}

    <form method="POST" action="{% url 'accounting:charge_patient_create' payment.pk claim.pk %}">{% csrf_token %}
        <div class="row" id="procedure-table">

            {{ pc_formset.management_form }}

            <table class="table table-striped table-condensed">
                <thead>
                    <tr>
                        <th>CPT Code</th>
                        <th>Charge</th>
                        <th>Patient Responsibility</th>
                        <th>Payment</th>
                        <th>Reference</th>
                        <th>Balance</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody class="row found-procedure" id="found-procedure">
                    {% for pc_form in pc_formset %}
                        <tr class="pat-resp-formset">
                            <input
                                type="hidden"
                                name="{{pc_form.payment.html_name}}"
                                id="{{pc_form.payment.auto_id}}"
                                value="{{payment.pk}}"
                            >
                            <td>{{pc_form.procedure|add_class:"form-control"}}</td>
                            <td>{{pc_form.charge_amount|add_class:"form-control charge-amount"}}</td>
                            <td>{{pc_form.resp_type|add_class:"form-control"}}</td>

                            {% if payment.payer_type == "Patient" %}
                                <td>{{pc_form.apply_amount|add_class:"form-control apply-amount"}}</td>
                                <td>{{pc_form.reference|add_class:"form-control"}}</td>
                            {% else %}
                                <td>{{pc_form.apply_amount|add_class:"form-control apply-amount"|attr:"disabled"}}</td>
                                <td>{{pc_form.reference|add_class:"form-control"|attr:"disabled"}}</td>
                            {% endif %}

                            <td class="balance" style="padding-left: 10px;"></td>
                            <td></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if payment.payer_type != "Patient" %}
            <div class="pull-right">
                Please note that payer type of given payment ID is not "Patient". Applying payment here is not allowed.
            </div>
        {% endif %}
        <br>

        <input type="submit" class="btn btn-success" value="Make Payment" id="submit-make-payment">
        <a href="{% url 'dashboard:dashboard' %}" class="padding-btn margin-left link-btn-danger">Cancel</a>
    </form>
</div>


<script>
'use strict';
(function() {

    $('#payment_id').change(setFlashingButton)
    $('#claim_id').change(setFlashingButton)

    function setFlashingButton() {
        var init_p_id = '{{payment.pk}}';
        var init_c_id = '{{claim.pk}}';
        var payment_id = $('#payment_id').val();
        var claim_id = $('#claim_id').val();

        var submitMakePayment = $('#submit-make-payment');
        var submitSearchProcedure = $('#submit-search-procedure');

        if(payment_id == init_p_id &&
                claim_id == init_c_id) {
            submitMakePayment.prop('disabled', false);
            submitSearchProcedure.removeClass('suggest-pushing');
        }
        else {
            submitMakePayment.prop('disabled', true);
            submitSearchProcedure.addClass('suggest-pushing');
        }
    }

    $('.charge-amount').keyup(updateBalance);
    $('.apply-amount').keyup(updateBalance);

    function updateBalance(e) {
        var input = $(e.currentTarget);
        var row = input.closest('tr');
        var ca = row.find('.charge-amount').val();
        var aa = row.find('.apply-amount').val();

        if(ca && aa)
            row.find('.balance').html(Math.roundP(ca - aa, 2));
        else if(ca)
            row.find('.balance').html(Math.roundP(ca, 2));
    }

})();
</script>


<script src="{% static 'js/jquery.formset.js' %}"></script>
<script>
    $('.pat-resp-formset').formset({
        addText: 'Add Line',
        deleteText: 'Remove',
        keepFieldValues: 'input[name$="-payment"]',
    });
</script>
{% endblock body %}
