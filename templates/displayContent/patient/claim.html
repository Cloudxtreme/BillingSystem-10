{% extends "base.html" %}
{% load widget_tweaks %}
{% load staticfiles %}

    {% block title %} Claim Details {% endblock title %}

    {% block script %}


    {% endblock script %}
    {% block link %}
    {% endblock link %}


{% block body %}

<div class="container-fluid" style=" max-width:1400px">
    <div class="col-xs-6" style="padding-right:20px; border-right: 1px solid #ccc;">
        <h3 class="text-center">Claim Searches</h3>

        <table id="table_search" class="table table-condensed table-hover" data-current-claim-id>
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Created</th>
                    <th>Patient Name</th>
                    <th>$ Charge</th>
                </tr>
            </thead>
            <tbody>
                {% for ele in claimSearches %}
                    <tr data-claim-id="{{ele.pk}}">
                        <td>idk</td>
                        <td>{{ele.created}}</td>
                        <td>{{patient_info.last_name}}, {{patient_info.first_name}}</td>
                        <td>{{ele.total_charge}}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

            {{claimSearches}}
    </div>
    <div class="col-xs-6">
        <h3 class="text-center">Claim Details</h3>
        <h4>Payment Summary</h4>
        <div class="row" style="margin: 0px 5px;">
            <table class="table table-striped table-condensed found-table" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th>Total Charge</th>
                        <th>Ins Pmt</th>
                        <th>Adjustments</th>
                        <th>Ins Bal</th>
                        <th>Pat Resp</th>
                        <th>Pat Pmt</th>
                        <th>Total Bal</th>
                    </tr>
                </thead>
                <tbody id="claim-detail-body"></tbody>
            </table>
        </div>
        <br>
        <div class="text-center">
            Note: To view the complete payment info, click <a href="#" id="payment-detail-link">Payment Detail</a>.
        </div>
        <br>
        <h4>Notes</h4>
        <table class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Entered By</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="note-body"></tbody>
        </table>

        <div class="row">
            <form method="POST" action="{% url 'accounting:api_create_note' %}" id="form-note-create">{% csrf_token %}
                <div class="col-sm-10">
                    Add Note: <input
                        type="text"
                        name="{{note_form.desc.html_name}}"
                        id="{{note_form.desc.auto_id}}"
                        value="{{note_form.value}}"
                        class="form-control"
                        style="display: inline-block; width: 80%;"
                        required
                    >
                    <input
                        type="hidden"
                        name="{{note_form.claim.html_name}}"
                        id="{{note_form.claim.auto_id}}"
                    >
                </div>
                <div class="col-sm-2"><input type="submit" class="btn btn-block btn-default" value="Save"></div>
            </form>
        </div>
    </div>
</div>


<script type="text/template" class="claim-detail-template">
    <tr>
        <td><%= claim.total_charge %></td>
        <td><%= claim.ins_pmnt_per_claim %></td>
        <td><%= claim.ins_adjustment_per_claim %></td>
        <td><%= claim.ins_balance %></td>
        <td><%= claim.pat_responsible_per_claim %></td>
        <td><%= claim.pat_pmnt_per_claim %></td>
        <td><%= claim.total_balance %></td>
    </tr>
</script>
<script type="text/template" class="notes-template">
    <% if(notes.length < 1) { %>
        <tr>
            <td colspan="100" class="text-center not-found">There is no note for this claim.</td>
        </tr>
    <% } else {
        _.each(notes, function(note, i) {
            var n = note.fields;
            var dt = moment(n.created);
    %>
        <tr>
            <td><%= n.desc %></td>
            <td><%= n.author.first_name %></td>
            <td><%= dt.format('MM/DD/YYYY hh:mm A') %></td>
        </tr>
    <% }); } %>
</script>
<script>
// 'use strict';
(function() {
    var tableSearch = $('#table_search');

    $("#table_search tbody tr").click(function(e) {
        var row = $(e.currentTarget);
        var claim_id = row.data('claim-id');
        renderClaimDetailsTemplate(claim_id, row);
        window.sessionStorage.claim_id = claim_id;
    });

    function renderClaimDetailsTemplate(claim_id, row) {
        var notesTemplate =
                _.template($('script.notes-template').html());
        var claimDetailTemplate =
                _.template($('script.claim-detail-template').html());
        var claimDetailBody = $('#claim-detail-body')
        var notesBody = $('#note-body')
        $.get("{% url 'displayContent:api_view_claim' %}?claim_id="
                + claim_id)
            .done(function(data) {
                claimDetailBody.html(claimDetailTemplate({
                        err: false,
                        claim: data.claim[0].fields}));
                notesBody.html(notesTemplate({
                        err: false,
                        notes: data.notes}));

                $('#payment-detail-link').prop('href',
                        `{% url 'displayContent:payment_details' %}?claim_id=`
                        + claim_id);
            })
            .fail(function() {
                claimDetailBody.html(
                    `<td colspan="100" class="text-center not-found">
                    An unexpected error has occured.  Please try again later.
                    </td>`);
                notesBody.html(
                    `<td colspan="100" class="text-center not-found">
                    An unexpected error has occured.  Please try again later.
                    </td>`);
            })
            .always(function() {
                tableSearch.data('current-claim-id', claim_id);
                row.siblings().removeClass('selected');
                row.addClass('selected');
            })
    }

    // Init with first line of search table
    var claim_id = window.sessionStorage.claim_id;
    var init_row = tableSearch
            .find('tbody tr')
            .first()
    if(tableSearch.find('[data-claim-id=' + claim_id + ']').length > 0)
        init_row = tableSearch.find('[data-claim-id=' + claim_id + ']')

    var init_claim_id = init_row
            .data('claim-id');
    renderClaimDetailsTemplate(init_claim_id, init_row);
})();
</script>


<script>
'use strict';
(function() {
    var form = $('#form-note-create');
    form.submit(function(e) {
        e.preventDefault();

        var form = $(e.currentTarget);
        var tableSearch = $('#table_search');
        var currentClaimId = tableSearch.data('current-claim-id');
        form.find('#{{note_form.claim.auto_id}}').val(currentClaimId);

        $.post(form.attr('action'), form.serialize())
            .done(function(data) {
                location.reload();
            })
            .fail(function() {
                console.log('failure');
            })
    });
})();
</script>
{% endblock body %}
