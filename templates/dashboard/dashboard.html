{% extends "base.html" %}

{% load staticfiles %}

{% block script %}
    <script src="{% static 'dashboard/js/clock.js' %}"></script>
{% endblock script %}

{% block link %}

<style>
    a{
        margin-left: 5px;
    }

    table#notes_table{
        display : block;
        width : 100%;
        height: inherit;
        max-height: 200px;
        table-layout:fixed;
    }
    table#notes_table tbody#note-body{
        width: inherit;
        display: table;
    }

    table#notes_table thead{
        width: inherit;
        display: table;
    }
    div#table_div{
        overflow-y: scroll;
    }
    .table tbody td {
        text-align: center;   
    }
    .table thead th {
        text-align: center;   
    }
</style>

{% endblock link %}

{% block body %}

<div class="container">

    <div class="row">
<!--         <a href="{% url 'accounting:payment_apply_read' %}" class="btn btn-info pull-right">Apply Payment</a>
        <a href="{% url 'accounting:payment_create' %}" class="btn btn-primary pull-right">Make Payment</a>
        <a href="{% url 'accounting:gross_payment_summary' %}" class="btn btn-danger pull-right">Payment summary (gross)</a>
        <a href="{% url 'displayContent:view_dashboard' %}" class="btn btn-success pull-right">Patient Dashboard</a>
        <a href="{% url 'accounting:claim_summary' %}" class="btn btn-info pull-right">Claim Summary</a>
        <a href="{% url 'admin:accounting_payment_changelist' %}" class="btn btn-primary pull-right">Payment received Summary</a>
        <a href="{% url 'admin:accounting_apply_changelist' %}" class="btn btn-danger pull-right">Apply Payment Summary</a> -->

        
    </div>


    <br>
    <div class="jumbotron" >
        <div class="row">
            <div class="col-sm-10">
                <h1>Dashboard</h1>
            </div>
            <div class="col-sm-2">
                <canvas class="pull-right" id="canvas" width="120" height="120"></canvas>
            </div>
        </div>
        <p>
            <a href="{% url 'report:TransactionReport' %}" class="btn btn-default">Transaction report</a>
        </p>
    </div>

    <div class="col-sm-12">
        <div class="col-sm-3">
            <table class="top table table-bordered table-condensed">
                <thead>
                    <tr>
                    <th>Patients</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><a href="http://127.0.0.1:8000/admin/infoGatherer/personal_information/add/">Register new patient</a></td></tr>
                    <tr><td><a href="{% url 'displayContent:view_dashboard' %}">Patient Dashboard</a></td></tr>
                </tbody>
            </table>
        </div>
        <div class="col-sm-3">
            <table class="top table table-bordered table-condensed">
                <thead>
                    <tr>
                    <th>Claims</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><a href="{% url 'infoGatherer:post_ad' %}">Create claim</a></td></tr>
                    <tr><td><a href="{% url 'accounting:claim_summary' %}">Claim summary</a></td></tr>
                    <tr><td>Claim Status Report</td></tr>
                </tbody>
            </table>
        </div>
        <div class="col-sm-3">
            <table class="top table table-bordered table-condensed">
                <thead>
                    <tr>
                    <th>Administration</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Provider Maintenance</td>
                    </tr>
                    <tr>
                        <td>Payer Maintenance</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="col-sm-3">
            <table class="top table table-bordered table-condensed">
                <thead>
                    <tr>
                    <th>Payments</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><a href="{% url 'accounting:payment_create' %}">Create Payments</a></td></tr>
                    <tr><td><a href="{% url 'accounting:payment_apply_read' %}">Apply payment to patient</a></td></tr>
                    <tr><td><a href="{% url 'accounting:gross_payment_summary' %}">Gross payment summary</a></td></tr>
                    <tr><td><a href="{% url 'admin:accounting_payment_changelist' %}">Payment received summary</a></td></tr>
                    <tr><td><a href="{% url 'admin:accounting_apply_changelist' %}">Applied payments summary</a></td></tr>
                </tbody>
            </table>
        </div>
    </div>
        
    
    
    <div class="col-sm-12">
        <h4>Notes</h4>
        <div id="table_div">
            <table id="notes_table" class="table table-striped table-condensed">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Entered By</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="note-body"></tbody>
            </table>
        </div>
        <div class="row">
            <form method="POST" action="{% url 'dashboard:api_create_note' %}" id="form-note-create">{% csrf_token %}
                <div class="col-sm-8">
                    Add Note: 
                    <input type="text" name="desc" id="desc" class="form-control" style="display: inline-block; width: 80%;" required >
                </div>
                <div class="col-sm-2"><input type="submit" class="btn btn-block btn-default" value="Save"></div>
                <div class="col-sm-2"><button id="delete" class="btn btn-block btn-danger" value="Delete">Delete</button></div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    $("table.top tbody tr").addClass("info");
    $("table.top thead tr").addClass("danger");
})
</script>

<script type="text/template" class="notes-template">
    <% if(notes.length < 1) { %>
        <tr>
            <td colspan="100" class="text-center not-found">There are no notes on the dashboard yet! </td>
        </tr>
    <% } else {
        _.each(notes, function(note, i) {
            var n = note.fields;
            var dt = moment(n.created);
    %>
        <tr>
            <td><%= n.desc %></td>
            <td><%= n.author.first_name %></td>
            <td><%= dt.format('MM/DD/YYYY hh:mm A') %></td>
        </tr>
    <% }); } %>
</script>

<script>
'use strict';
(function() {
    var form = $('#form-note-create');
    form.submit(function(e) {
        e.preventDefault();
        var form = $(e.currentTarget);
        $.post(form.attr('action'), form.serialize())
            .done(function(data) {
                $("#desc").val("");
                renderNotesDetailsTemplate();

            })
            .fail(function(error) {
                console.log('failure');
            });
    });

    $("#delete").click(function(e){
        e.preventDefault();
        $.post("{% url 'dashboard:api_delete_note' %}", form.serialize())
            .done(function(data) {
                $("#desc").val("");
                renderNotesDetailsTemplate();
            })
            .fail(function(error) {
                console.log('failure to delete notes');
            });
    });
})();
</script>

<script>
function renderNotesDetailsTemplate() {
    var notesTemplate =
            _.template($('script.notes-template').html());
    var notesBody = $('#note-body')
    $.get("{% url 'dashboard:api_create_note' %}?get=1")
        .done(function(data) {
            // console.log("getting stuff for notes!. in done@@! ");
            notesBody.html(notesTemplate({
                    err: false,
                    notes: data.notes}));
            var elem = document.getElementById('table_div');
            elem.scrollTop = elem.scrollHeight;
        })
        .fail(function() {
            notesBody.html(
                `<td colspan="100" class="text-center not-found">
                An unexpected error has occured.  Please try again later!!.
                </td>`);
        })
        .always(function() {
        })
}
</script>
<script>

$(document).ready(function () {
    renderNotesDetailsTemplate();

})
</script>

<script>
    // Clock
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    var radius = canvas.height / 2;
    ctx.translate(radius, radius);
    radius = radius * 0.90
    setInterval(drawClock, 1000);
</script>


{% endblock body %}
